# DATA DRIFT DETECTION WORKFLOW (Phase 3)
#
# PURPOSE: When the DB becomes the source of truth (Phase 3 of DB migration),
# all catalog data changes must go through the database. Direct edits to
# src/data/*.ts files should be flagged by CI.
#
# CURRENT STATUS: Active (warning mode). This workflow detects direct edits to
# protected catalog data files and posts an informational warning. It does NOT
# block merges — continue-on-error is enabled for a gradual rollout period.
#
# When activated, this workflow will:
#   1. Detect if any protected src/data/*.ts files were modified in the PR
#   2. Skip if the PR title or commit messages contain [db-export] (auto-generated)
#   3. Post a warning annotation with guidance to use the DB pipeline
#
# See DB_MIGRATION_PLAN.md Phase 3 for context.

name: Data Drift Check

on:
  pull_request:
    paths:
      - 'src/data/manualAlternatives.ts'
      - 'src/data/researchAlternatives.ts'
      - 'src/data/trustOverrides.ts'
      - 'src/data/positiveSignals.ts'
      - 'src/data/usVendors.ts'
      - 'src/data/furtherReading.ts'
      - 'src/data/landingCategoryGroups.ts'
      - 'src/data/scoringData.ts'

jobs:
  check-data-drift:
    runs-on: ubuntu-latest
    # Warning mode: does not block PR merges during initial rollout
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for auto-generated export marker
        id: check-marker
        run: |
          # Allow PRs that are auto-generated DB exports
          PR_TITLE="${{ github.event.pull_request.title }}"
          if echo "$PR_TITLE" | grep -qi '\[db-export\]'; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "PR title contains [db-export] marker — skipping drift check."
            exit 0
          fi

          # Also check commit messages in the PR for the marker
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          COMMITS=$(git log --format='%s' "origin/${BASE_REF}...HEAD" 2>/dev/null || true)
          if echo "$COMMITS" | grep -qi '\[db-export\]'; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Commit message contains [db-export] marker — skipping drift check."
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Check for direct TS data file edits
        if: steps.check-marker.outputs.skip != 'true'
        run: |
          # Get the list of changed files in this PR compared to the base branch
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          CHANGED_FILES=$(git diff --name-only "origin/${BASE_REF}...HEAD" -- 'src/data/*.ts')

          if [ -z "$CHANGED_FILES" ]; then
            echo "No direct edits to src/data/*.ts files detected."
            exit 0
          fi

          # Only flag changes to protected catalog data files
          # (e.g., scoringConfig.ts contains constants, not data — it is allowed)
          PROTECTED_FILES=(
            "src/data/manualAlternatives.ts"
            "src/data/researchAlternatives.ts"
            "src/data/trustOverrides.ts"
            "src/data/positiveSignals.ts"
            "src/data/usVendors.ts"
            "src/data/furtherReading.ts"
            "src/data/landingCategoryGroups.ts"
            "src/data/scoringData.ts"
          )

          VIOLATIONS=""
          for file in $CHANGED_FILES; do
            for protected in "${PROTECTED_FILES[@]}"; do
              if [ "$file" = "$protected" ]; then
                VIOLATIONS="${VIOLATIONS}  - ${file}\n"
              fi
            done
          done

          if [ -n "$VIOLATIONS" ]; then
            echo "::warning::Data drift detected — protected catalog data files were edited directly."
            echo ""
            echo "The following protected data files were modified:"
            echo -e "$VIOLATIONS"
            echo ""
            echo "========================================================================"
            echo "  DATA DRIFT WARNING"
            echo "========================================================================"
            echo ""
            echo "  In Phase 3 of the DB migration, the database is the source of truth"
            echo "  for catalog data. Direct edits to these TS files will cause drift"
            echo "  between the DB and the codebase."
            echo ""
            echo "  To update catalog data correctly:"
            echo "    1. Make changes in the database via the admin workflow"
            echo "    2. Run 'npm run db:export' to regenerate TS files"
            echo "    3. Commit the auto-generated TS files with [db-export] in the"
            echo "       commit message or PR title"
            echo ""
            echo "  If this is an intentional manual edit (e.g., fixing a schema issue"
            echo "  or adding new fields), this warning can be safely ignored."
            echo ""
            echo "========================================================================"
            echo ""
            echo "NOTE: This check is currently in WARNING mode and will not block merges."
            exit 0
          fi

          echo "Changed TS files are not protected catalog data files. OK."
